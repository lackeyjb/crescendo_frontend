"use strict";angular.module("crescendoApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ui.router","ngSanitize","ngTouch","angular-chartist","ui.gravatar"]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c){a.defaults.withCredentials=!0,b.state("home",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"DashboardCtrl",onEnter:["$state","AuthService",function(a,b){b.isAuthenticated()||a.go("home")}]}).state("game1",{url:"/game1",templateUrl:"views/game1.html",controller:"Game1Ctrl",onEnter:["$state","AuthService",function(a,b){b.isAuthenticated()||a.go("home")}]}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"AuthCtrl"}).state("register",{url:"/register",templateUrl:"views/register.html",controller:"AuthCtrl"}),c.otherwise("/")}]).config(["gravatarServiceProvider",function(a){a.defaults={"default":"mm"},a.secure=!0,a.protocol="my-protocol"}]),angular.module("crescendoApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("crescendoApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("crescendoApp").controller("AuthCtrl",["$scope","$rootScope","AuthService",function(a,b,c){a.register=function(){c.register(a.user).success(function(a){b.$emit("auth:new-registration",a)}).error(function(){alert("Something went wrong, please try again.")})},a.login=function(){c.login(a.session).success(function(a){b.$emit("auth:login",a)}).error(function(){alert("Something went wrong, please try again."),a.session={}})}}]),angular.module("crescendoApp").controller("NavCtrl",["$scope","$rootScope","$state","$browser","AuthService",function(a,b,c,d,e){a.tabs=[{state:"home",label:"Home",active:!0,isPublic:!0},{state:"dashboard",label:"Dashboard",active:!0,isPublic:!1}],a.getTabClass=function(a){return a.active?"active":""},a.$on("$stateChangeSuccess",function(){a.tabs.forEach(function(a){a.active=c.is(a.state)})}),a.isAuthenticated=function(){return!!a.user},a.showTab=function(b){return b.isPublic||a.isAuthenticated()},e.getSession().success(function(b){a.user=b}),a.logout=function(){e.logout().success(function(){b.$emit("auth:logout")})},b.$on("auth:new-registration",function(b,d){a.user=d,c.go("dashboard")}),b.$on("auth:login",function(b,d){a.user=d,c.go("dashboard")}),b.$on("auth:logout",function(){a.user=null,c.go("home")})}]),angular.module("crescendoApp").controller("Game1Ctrl",["$state","$scope","AuthService","ScoreService",function(a,b,c,d){c.getSession().success(function(a){b.userId=a.id});var e=new Phaser.Game(640,480,Phaser.AUTO,"gameview"),f=function(){this.player=null,this.platforms=null,this.sky=null,this.bubbles=null,b.score=0,this.increaseScoreBy=10,this.scoreText=0,this.lives=3,this.livesText=3,this.facing="left",this.edgeTimer=0,this.jumpTimer=0,this.wasStanding=!1,this.cursors=null,this.gameBubbleCollection=[],this.cMajorScale=["bubbleC","bubbleD","bubbleE","bubbleF","bubbleG","bubbleA","bubbleB"],this.bubbleBurst=null};f.prototype={init:function(){this.world.resize(640,2e3),this.physics.startSystem(Phaser.Physics.ARCADE),this.physics.arcade.gravity.y=750,this.physics.arcade.skipQuadtree=!1},preload:function(){this.load.image("trees","images/trees.png"),this.load.image("clouds","images/clouds.png"),this.load.image("bubbleA","images/a-bubble.png"),this.load.image("bubbleAsh","images/a-sh-bubble.png"),this.load.image("bubbleB","images/b-bubble.png"),this.load.image("bubbleC","images/c-bubble.png"),this.load.image("bubbleCsh","images/c-sh-bubble.png"),this.load.image("bubbleD","images/d-bubble.png"),this.load.image("bubbleDsh","images/d-sh-bubble.png"),this.load.image("bubbleE","images/e-bubble.png"),this.load.image("bubbleF","images/f-bubble.png"),this.load.image("bubbleFsh","images/f-sh-bubble.png"),this.load.image("bubbleG","images/g-bubble.png"),this.load.image("bubbleGsh","images/g-sh-bubble.png"),this.load.image("platform","images/moving_platform.png"),this.load.image("ice-platform","images/ice-platform.png"),this.load.audio("bubbleburst","audio/woodblock.mp3"),this.load.spritesheet("dude","images/crescendodude.png",49.6,68)},create:function(){this.stage.backgroundColor="#2f9acc",this.sky=this.add.tileSprite(0,0,640,480,"clouds"),this.sky.fixedToCamera=!0,this.add.sprite(0,1906,"trees"),this.platforms=this.add.physicsGroup();for(var a=0,b=64,c=0;19>c;c++){var d=c%2===1?"platform":"ice-platform",f=this.platforms.create(a,b,d);f.body.velocity.x=this.rnd.between(100,150),Math.random()>.5&&(f.body.velocity.x*=-1),a+=200,a>=600&&(a=0),b+=104}this.platforms.setAll("body.allowGravity",!1),this.platforms.setAll("body.immovable",!0),this.player=this.add.sprite(320,1952,"dude"),this.physics.arcade.enable(this.player),this.player.body.collideWorldBounds=!0,this.player.body.setSize(45,52,0,16),this.player.animations.add("left",[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],30,!0),this.player.animations.add("right",[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],30,!0),this.camera.follow(this.player),this.bubbleSpawn(),this.bubbleBurst=e.add.audio("bubbleburst"),this.scoreText=e.add.text(16,16,"score: 0",{fontSize:"32px",fill:"#000"}),this.livesText=e.add.text(100,40,"lives: 3",{fontSize:"32px",fill:"#000"}),this.cursors=this.input.keyboard.createCursorKeys(),this.jump=this.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)},wrapPlatform:function(a){a.body.velocity.x<0&&a.x<=-160?a.x=640:a.body.velocity.x>0&&a.x>=640&&(a.x=-160)},setFriction:function(a,b){"ice-platform"===b.key&&(a.body.x-=b.body.x-b.body.prev.x)},update:function(){this.sky.tilePosition.y=-(.7*this.camera.y),this.platforms.forEach(this.wrapPlatform,this),this.physics.arcade.collide(this.player,this.platforms,this.setFriction,null,this),this.physics.arcade.collide(this.bubbles,this.platforms),this.physics.arcade.collide(this.bubbles);var c=120-this.badNotesArray().length*this.increaseScoreBy;this.lives>0&&b.score<c?this.physics.arcade.overlap(this.player,this.bubbles,this.collectBubble,null,this):(d.postScore(b.userId,b.score).success(function(){console.log("Score posted")}).error(function(){console.log("Error, score did not post")}),e.destroy(),a.go("dashboard"));var f=this.player.body.blocked.down||this.player.body.touching.down;this.scoreText.x=this.camera.x,this.scoreText.y=this.camera.y,this.livesText.x=this.camera.x,this.livesText.y=this.camera.y+30,this.player.body.velocity.x=0,this.cursors.left.isDown?(this.player.body.velocity.x=-200,"left"!==this.facing&&(this.player.anchor.setTo(.5,0),this.player.scale.x=-1,this.player.play("left"),this.facing="left")):this.cursors.right.isDown?(this.player.body.velocity.x=200,"right"!==this.facing&&(this.player.scale.x=1,this.player.play("right"),this.facing="right")):"idle"!==this.facing&&(this.player.animations.stop(),this.player.frame="left"===this.facing?0:5,this.facing="idle"),!f&&this.wasStanding&&(this.edgeTimer=this.time.time+250),(f||this.time.time<=this.edgeTimer)&&(this.cursors.up.isDown||this.jump.isDown)&&this.time.time>this.jumpTimer&&(this.player.body.velocity.y=-500,this.jumpTimer=this.time.time+750),this.wasStanding=f},bubbleRandomizer:function(){return _.sample(["bubbleA","bubbleAsh","bubbleB","bubbleC","bubbleCsh","bubbleD","bubbleDsh","bubbleE","bubbleF","bubbleFsh","bubbleG","bubbleGsh"])},bubbleSpawn:function(){var a=this;a.bubbles=e.add.group(),a.bubbles.enableBody=!0;for(var b=0;12>b;b++){var c=a.bubbles.create(70*b,a.camera.screenView.height+1e3,a.bubbleRandomizer());this.gameBubbleCollection.push(c),c.body.bounce.y=.85+.2*Math.random(),c.body.collideWorldBounds=!0,c.body.gravity.y=Math.floor(41*Math.random())-740}},collectBubble:function(a,c){c.kill(),this.bubbleBurst.play(),_.contains(this.cMajorScale,c.key.toString())?(b.score+=this.increaseScoreBy,this.scoreText.text="Score: "+b.score):(this.lives-=1,this.livesText.text="Lives: "+this.lives)},badNotesArray:function(){var a=_.map(this.gameBubbleCollection,function(a){return a.key.toString()});return _.difference(a,this.cMajorScale)}},e.state.add("Game",f,!0)}]),angular.module("crescendoApp").controller("DashboardCtrl",["$scope","$state","AuthService","ScoreService",function(a,b,c,d){function e(b){_.each(b,function(b){a.scores.push(b.points),a.labels.push(b.label)}),f(a.scores)}function f(b){var c=b.reduce(function(a,b){return a+b}),d=c/b.length;a.avgScore=Math.floor(d)}c.getSession().success(function(b){a.user=b}),a.goToGame=function(){b.go("game1")},a.scores=[],a.labels=[],d.getScores().success(e).error(function(){console.log("Error")}),this.lineData={labels:a.labels,series:[a.scores]},$("#myModal").on("hidden.bs.modal",function(a){$("#myModal iframe").attr("src",$("#myModal iframe").attr("src"))})}]),angular.module("crescendoApp").service("AuthService",["$http",function(a){var b=this;b.currentUser=null,b.isAuthenticated=function(){return!!b.currentUser},b.getSession=function(){var c=a.get("/api/sessions/");return c.success(function(a){console.log("getSession returned user = "+JSON.stringify(a)),b.currentUser=a}),c},b.getSession(),b.register=function(c){var d=a.post("/api/users/",{user:c});return d.success(function(a){b.currentUser=a}),d},b.login=function(c){var d=a.post("/api/sessions/",{session:c});return d.success(function(a){b.currentUser=a}),d},b.logout=function(){var c=a["delete"]("/api/sessions/");return c.success(function(){b.currentUser=null}),c}}]),angular.module("crescendoApp").service("ScoreService",["$http",function(a){this.getScores=function(){return console.log(a.get("/api/scores")),a.get("/api/scores")},this.postScore=function(b,c){return console.log("postScore of: "+JSON.stringify(c)),a.post("/api/scores",{score:{userId:b,points:c}})}}]);